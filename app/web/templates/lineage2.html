<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据血缘关系可视化</title>
    <script src="https://unpkg.com/@antv/g6@4.8.15/dist/g6.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        body {
            background-color: #f5f7fa;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #1e6bdd 0%, #0d4ba3 100%);
            color: white;
            border-radius: 8px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        .tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 3px solid transparent;
        }
        .tab.active {
            background-color: #f0f7ff;
            border-bottom: 3px solid #1e6bdd;
            color: #1e6bdd;
        }
        .view-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            min-height: 600px;
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 6px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 0;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 12px;
        }
        .search-box {
            flex: 1;
            min-width: 280px;
            padding: 10px 15px;
            border: 1px solid #d1d9e6;
            border-radius: 6px;
        }
        .search-box::placeholder {
            color: #a0aec0;
        }
        .btn {
            padding: 10px 20px;
            background-color: #1e6bdd;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #0d4ba3;
        }
        .chart-container {
            width: 100%;
            height: 580px;
            border: 1px solid #e1e8f0;
            border-radius: 8px;
            background: #f8fafc;
            position: relative;
        }
        .no-data-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #718096;
            text-align: center;
            padding: 20px;
        }
        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(30, 41, 59, 0.9);
            color: white;
            border-radius: 6px;
            pointer-events: none;
            font-size: 13px;
            max-width: 280px;
            z-index: 100;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #1e6bdd;
            display: none;
        }
        .error-message {
            color: #e53e3e;
            text-align: center;
            margin: 10px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>数据血缘关系可视化</h1>
            <p>表级血缘视图 & ETL批次溯源视图</p>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-view="table-lineage">表级血缘视图</div>
            <div class="tab" data-view="etl-lineage">ETL批次溯源视图</div>
        </div>
        
        <div class="controls">
            <input type="text" class="search-box" id="search-input" placeholder="输入表名进行搜索...">
            <button class="btn" id="search-btn">搜索</button>
            <button class="btn" id="fit-view">适应画布</button>
        </div>
        
        <div class="error-message" id="error-message"></div>
        <div class="loading" id="loading-indicator">加载中...</div>
        
        <div class="view-container">
            <div class="view active" id="table-lineage">
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #10b981;"></div>
                        <span>source_table</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #10b981;"></div>
                        <span>target_table</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f97316;"></div>
                        <span>文件节点</span>
                    </div>
                </div>
                <div class="chart-container" id="table-lineage-chart">
                    <div class="no-data-message" id="table-no-data" style="display: none;">
                        没有查到相关的表级血缘数据
                    </div>
                </div>
            </div>
            
            <div class="view" id="etl-lineage">
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #10b981;"></div>
                        <span>表节点</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #8b5cf6;"></div>
                        <span>ETL流程节点</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f97316;"></div>
                        <span>文件节点</span>
                    </div>
                </div>
                <div class="chart-container" id="etl-lineage-chart">
                    <div class="no-data-message" id="etl-no-data" style="display: none;">
                        没有查到相关的批次溯源数据
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 模拟数据（包含时间信息）
        const mock_lineage_records = [
            {"batch_no":"xx", "workflow_code":"wf1", "etl_desc":"etl aggr", "source_table":"dws.tb_dmd_cleaned", "source_type":"table", "target_table":"dws.tb_aggr", "target_type":"table", "created_at":"2025-11-07 23:23:23"},
            {"batch_no":"xx", "workflow_code":"wf1", "etl_desc":"etl aggr", "source_table":"dwd.tb_dim2", "source_type":"table", "target_table":"dws.tb_aggr", "target_type":"table", "created_at":"2025-11-07 23:23:23"},
            {"batch_no":"xx", "workflow_code":"wf2", "etl_desc":"etl clean", "source_table":"dwd.tb_dmd", "source_type":"table", "target_table":"dws.tb_dmd_cleaned", "target_type":"table", "created_at":"2025-11-07 23:03:23"},
            {"batch_no":"xx", "workflow_code":"wf3", "etl_desc":"etl normalization", "source_table":"stagingDB.tb_source", "source_type":"table", "target_table":"dwd.tb_dmd", "target_type":"table", "created_at":"2025-11-07 22:43:23"},
            {"batch_no":"xx", "workflow_code":"wf4", "etl_desc":"source file imported", "source_table":"test.csv", "source_type":"file", "target_table":"stagingDB.tb_source", "target_type":"table", "created_at":"2025-11-07 22:43:23"},
        ];

        // 分别存储两种视图的数据
        let tableLineageData = mock_lineage_records;
        let etlLineageData = mock_lineage_records;
        let currentGraph = null;

        // 清空画布并显示无数据提示
        function showNoDataMessage(isTableView) {
            const chartId = isTableView ? 'table-lineage-chart' : 'etl-lineage-chart';
            const noDataId = isTableView ? 'table-no-data' : 'etl-no-data';
            
            // 清空画布
            const container = document.getElementById(chartId);
            container.innerHTML = '';
            // 重新添加无数据提示元素
            const noDataElement = document.createElement('div');
            noDataElement.className = 'no-data-message';
            noDataElement.id = noDataId;
            noDataElement.textContent = isTableView ? '没有查到相关的表级血缘数据' : '没有查到相关的批次溯源数据';
            noDataElement.style.display = 'block';
            container.appendChild(noDataElement);
            
            // 重置当前图表引用
            currentGraph = null;
        }

        // 隐藏无数据提示
        function hideNoDataMessage(isTableView) {
            const noDataId = isTableView ? 'table-no-data' : 'etl-no-data';
            const noDataElement = document.getElementById(noDataId);
            if (noDataElement) {
                noDataElement.style.display = 'none';
            }
        }

        // 通用矩形节点注册（自适应大小）
        G6.registerNode('auto-size-node', {
            draw(cfg, group) {
                // 计算文本所需宽度
                const nameText = cfg.name || '';
                const timeText = cfg.time ? `时间: ${cfg.time}` : '';
                const workflowText = cfg.workflowCode ? `工作流: ${cfg.workflowCode}` : '';
                
                // 估算文本宽度（每个字符约8px）
                const nameWidth = Math.max(nameText.length * 8, 100);
                const timeWidth = timeText ? timeText.length * 8 : 0;
                const workflowWidth = workflowText ? workflowText.length * 8 : 0;
                
                // 计算节点宽度（取最大文本宽度并加边距）
                const nodeWidth = Math.max(nameWidth, timeWidth, workflowWidth) + 30;
                // 计算节点高度（根据内容行数计算）
                let lineCount = 1; // 至少有名称行
                if (cfg.nodeType === 'etl') lineCount = 3; // ETL节点有名称+工作流+时间
                else if (cfg.isTarget && cfg.time) lineCount = 2; // 目标表有名称+时间
                const nodeHeight = lineCount * 25 + 24; // 24是顶部标题栏高度
                
                // 创建节点背景
                const rect = group.addShape('rect', {
                    attrs: {
                        x: -nodeWidth / 2,
                        y: -nodeHeight / 2,
                        width: nodeWidth,
                        height: nodeHeight,
                        fill: 'white',
                        stroke: '#d1d9e6',
                        strokeWidth: 1.5,
                        radius: 0
                    }
                });

                // 顶部标题栏样式
                let topColor, topText;
                if (cfg.nodeType === 'file') {
                    topColor = '#f97316';
                    topText = '文件节点';
                } else if (cfg.nodeType === 'etl') {
                    topColor = '#8b5cf6';
                    topText = 'ETL流程节点';
                } else if (cfg.nodeType === 'table') {
                    topColor = '#10b981';
                    topText = cfg.isSource ? 'source_table' : '表节点';
                } else {
                    topColor = '#10b981';
                    topText = '表节点';
                }

                // 顶部标题栏
                group.addShape('rect', {
                    attrs: {
                        x: -nodeWidth / 2,
                        y: -nodeHeight / 2,
                        width: nodeWidth,
                        height: 24,
                        fill: topColor,
                        radius: 0
                    }
                });

                // 顶部标题文本
                group.addShape('text', {
                    attrs: {
                        text: topText,
                        x: 0,
                        y: -nodeHeight / 2 + 12,
                        fill: 'white',
                        fontSize: 12,
                        textAlign: 'center',
                        textBaseline: 'middle'
                    }
                });

                // 节点名称
                group.addShape('text', {
                    attrs: {
                        text: nameText,
                        x: 0,
                        y: -nodeHeight / 2 + 35, // 标题栏下方
                        fill: '#333',
                        fontSize: 12,
                        textAlign: 'center',
                        textBaseline: 'middle',
                        textWrap: 'wrap',
                        textMaxWidth: nodeWidth - 20
                    }
                });

                // ETL节点显示工作流和时间
                if (cfg.nodeType === 'etl' && cfg.time) {
                    // 工作流编号
                    group.addShape('text', {
                        attrs: {
                            text: workflowText,
                            x: 0,
                            y: -nodeHeight / 2 + 60,
                            fill: '#666',
                            fontSize: 10,
                            textAlign: 'center'
                        }
                    });
                    
                    // 时间
                    group.addShape('text', {
                        attrs: {
                            text: timeText,
                            x: 0,
                            y: -nodeHeight / 2 + 80,
                            fill: '#666',
                            fontSize: 9,
                            textAlign: 'center'
                        }
                    });
                }

                // 目标表节点显示时间
                if (cfg.nodeType === 'table' && cfg.isTarget && cfg.time) {
                    group.addShape('text', {
                        attrs: {
                            text: timeText,
                            x: 0,
                            y: -nodeHeight / 2 + 60,
                            fill: '#666',
                            fontSize: 9,
                            textAlign: 'center'
                        }
                    });
                }

                return rect;
            },
            // 设置锚点位置
            getAnchorPoints() {
                return [
                    [0, 0.5],   // 左侧中点
                    [1, 0.5]    // 右侧中点
                ];
            }
        });

        // 标签切换
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                
                this.classList.add('active');
                const viewId = this.getAttribute('data-view');
                document.getElementById(viewId).classList.add('active');
                
                // 更新搜索框提示文字
                const searchInput = document.getElementById('search-input');
                if (viewId === 'table-lineage') {
                    searchInput.placeholder = "输入表名进行搜索...";
                    renderTableLineage();
                } else {
                    searchInput.placeholder = "输入批次号进行搜索...";
                    renderETLLineage();
                }
            });
        });

        // 表级血缘视图
        function renderTableLineage() {
            hideNoDataMessage(true);
            const container = document.getElementById('table-lineage-chart');
            container.innerHTML = '';
            
            // 重新添加无数据提示元素（隐藏状态）
            const noDataElement = document.createElement('div');
            noDataElement.className = 'no-data-message';
            noDataElement.id = 'table-no-data';
            noDataElement.textContent = '没有查到相关的表级血缘数据';
            noDataElement.style.display = 'none';
            container.appendChild(noDataElement);
            
            const width = container.clientWidth;
            const height = container.clientHeight;

            const graph = new G6.Graph({
                container: 'table-lineage-chart',
                width,
                height,
                modes: { default: ['drag-canvas', 'zoom-canvas', 'drag-node'] },
                defaultNode: {
                    type: 'auto-size-node',
                },
                defaultEdge: {
                    type: 'line',
                    style: {
                        stroke: '#a0aec0',
                        endArrow: true
                    }
                },
                layout: {
                    type: 'dagre',
                    rankdir: 'LR',
                    nodesep: 60,
                    ranksep: 80
                }
            });

            currentGraph = graph;

            const nodes = [];
            const edges = [];
            const nodeMap = new Set();
            const sources = new Set();
            const targets = new Set();

            tableLineageData.forEach(r => {
                sources.add(r.source_table);
                targets.add(r.target_table);
            });

            tableLineageData.forEach(r => {
                if (!nodeMap.has(r.source_table)) {
                    nodes.push({
                        id: r.source_table,
                        name: r.source_table,
                        nodeType: r.source_type === 'file' ? 'file' : 'table',
                        source_type: r.source_type,
                        isSource: true,
                        isTarget: targets.has(r.source_table)
                    });
                    nodeMap.add(r.source_table);
                }
                if (!nodeMap.has(r.target_table)) {
                    nodes.push({
                        id: r.target_table,
                        name: r.target_table,
                        nodeType: 'table',
                        source_type: 'table',
                        isSource: sources.has(r.target_table),
                        isTarget: true,
                        time: tableLineageData.find(item => item.target_table === r.target_table)?.created_at
                    });
                    nodeMap.add(r.target_table);
                }
                edges.push({
                    source: r.source_table,
                    target: r.target_table,
                    etl_desc: r.etl_desc
                });
            });

            // 如果没有数据，显示提示
            if (nodes.length === 0) {
                showNoDataMessage(true);
                return;
            }

            graph.data({ nodes, edges });
            graph.render();

            graph.on('afterrender', () => {
                graph.fitView({ padding: [60, 60, 60, 60] });
                graph.paint();
            });
        }

        // ETL批次溯源视图
        function renderETLLineage() {
            hideNoDataMessage(false);
            const container = document.getElementById('etl-lineage-chart');
            container.innerHTML = '';
            
            // 重新添加无数据提示元素（隐藏状态）
            const noDataElement = document.createElement('div');
            noDataElement.className = 'no-data-message';
            noDataElement.id = 'etl-no-data';
            noDataElement.textContent = '没有查到相关的批次溯源数据';
            noDataElement.style.display = 'none';
            container.appendChild(noDataElement);
            
            const width = container.clientWidth;
            const height = container.clientHeight;

            const graph = new G6.Graph({
                container: 'etl-lineage-chart',
                width,
                height,
                modes: { default: ['drag-canvas', 'zoom-canvas', 'drag-node'] },
                defaultNode: {
                    type: 'auto-size-node',
                },
                defaultEdge: {
                    type: 'line',
                    style: {
                        stroke: '#a0aec0',
                        endArrow: true,
                        lineWidth: 1.5
                    }
                },
                layout: {
                    type: 'dagre',
                    rankdir: 'LR',
                    nodesep: 50,
                    ranksep: 100
                }
            });

            currentGraph = graph;

            const nodes = [];
            const edges = [];
            const nodeMap = new Set();
            const etlWorkflows = new Set(etlLineageData.map(r => `${r.workflow_code}_${r.etl_desc}`));
            const targetTableTimeMap = new Map();
            
            // 收集目标表的时间信息
            etlLineageData.forEach(record => {
                if (!targetTableTimeMap.has(record.target_table)) {
                    targetTableTimeMap.set(record.target_table, record.created_at);
                }
            });
            
            // 添加ETL节点
            etlWorkflows.forEach(uniqueId => {
                const [workflowCode, etlDesc] = uniqueId.split('_', 2);
                const etlRecord = etlLineageData.find(r => 
                    r.workflow_code === workflowCode && r.etl_desc === etlDesc
                );
                if (etlRecord) {
                    nodes.push({
                        id: uniqueId,
                        name: etlDesc,
                        nodeType: 'etl',
                        workflowCode: workflowCode,
                        time: etlRecord.created_at
                    });
                    nodeMap.add(uniqueId);
                }
            });

            // 添加表和文件节点及边
            etlLineageData.forEach(record => {
                // 源节点（表或文件）
                if (!nodeMap.has(record.source_table)) {
                    const nodeType = record.source_type === 'file' ? 'file' : 'table';
                    nodes.push({
                        id: record.source_table,
                        name: record.source_table,
                        nodeType: nodeType,
                        source_type: record.source_type,
                        isSource: true,
                        isTarget: false
                    });
                    nodeMap.add(record.source_table);
                }

                // 目标节点（表）
                if (!nodeMap.has(record.target_table)) {
                    nodes.push({
                        id: record.target_table,
                        name: record.target_table,
                        nodeType: 'table',
                        source_type: 'table',
                        isSource: false,
                        isTarget: true,
                        time: targetTableTimeMap.get(record.target_table)
                    });
                    nodeMap.add(record.target_table);
                }

                // 生成ETL节点的唯一ID
                const etlNodeId = `${record.workflow_code}_${record.etl_desc}`;
                
                // 边：源 -> ETL
                edges.push({
                    source: record.source_table,
                    target: etlNodeId
                });

                // 边：ETL -> 目标
                edges.push({
                    source: etlNodeId,
                    target: record.target_table
                });
            });

            // 如果没有数据，显示提示
            if (nodes.length === 0) {
                showNoDataMessage(false);
                return;
            }

            graph.data({ nodes, edges });
            graph.render();

            graph.on('afterrender', () => {
                graph.fitView({ padding: [60, 60, 60, 60] });
                graph.paint();
            });
        }

        // 搜索功能
        document.getElementById('search-btn').addEventListener('click', async () => {
            const searchTerm = document.getElementById('search-input').value.trim();
            const errorElement = document.getElementById('error-message');
            errorElement.style.display = 'none';
            
            if (!searchTerm) {
                errorElement.textContent = '请输入搜索内容';
                errorElement.style.display = 'block';
                return;
            }
            
            // 显示加载状态
            document.getElementById('loading-indicator').style.display = 'block';
            
            try {
                // 判断当前激活的视图
                const isTableViewActive = document.querySelector('.tab[data-view="table-lineage"].active') !== null;
                
                let apiUrl, responseData;
                
                if (isTableViewActive) {
                    apiUrl = `/api/table-lineage?table_name=${encodeURIComponent(searchTerm)}`;
                } else {
                    apiUrl = `/api/etl-lineage?batch_no=${encodeURIComponent(searchTerm)}`;
                }
                
                // 调用API接口
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`请求失败: ${response.statusText}`);
                }
                
                // 获取接口返回数据
                responseData = await response.json();
                
                // 检查返回数据是否为空
                if (!responseData || responseData.length === 0) {
                    showNoDataMessage(isTableViewActive);
                    document.getElementById('loading-indicator').style.display = 'none';
                    return;
                }
                
                // 更新数据并重新渲染
                if (isTableViewActive) {
                    tableLineageData = responseData;
                    renderTableLineage();
                } else {
                    etlLineageData = responseData;
                    renderETLLineage();
                }
                
            } catch (error) {
                console.error('搜索出错:', error);
                // 接口调用失败时清空画布并显示无数据提示
                const isTableViewActive = document.querySelector('.tab[data-view="table-lineage"].active') !== null;
                showNoDataMessage(isTableViewActive);
                errorElement.textContent = `搜索失败: ${error.message}`;
                errorElement.style.display = 'block';
            } finally {
                // 隐藏加载状态
                document.getElementById('loading-indicator').style.display = 'none';
            }
        });

        // 适应画布按钮
        document.getElementById('fit-view').addEventListener('click', () => {
            if (currentGraph) {
                currentGraph.fitView({ padding: [60, 60, 60, 60] });
                currentGraph.paint();
            }
        });

        // 初始化
        renderTableLineage();
    </script>
</body>
</html>
