# ================= 基础连接配置 =================
listen_addresses = '172.16.0.0/12'  # 仅监听内网IP（生产环境禁止0.0.0.0）
port = 5432
max_connections = 200               # 核心参数：与FastAPI连接池匹配（pool_size+max_overflow < max_connections）
superuser_reserved_connections = 10 # 预留超级用户连接（避免应用占满）

# ================= 内存优化（核心） =================
shared_buffers = 4GB                # 数据库共享缓冲区（物理内存的25%，如16G内存设4G）
work_mem = 64MB                     # 单查询工作内存（复杂排序/聚合调大，避免磁盘临时表）
maintenance_work_mem = 1GB          # 索引创建/真空清理内存
effective_cache_size = 12GB         # 系统可用缓存（物理内存的75%）
temp_buffers = 128MB                # 临时表缓冲区

# ================= IO与WAL优化（高写入场景） =================
wal_buffers = 16MB                  # WAL缓冲区（默认-1为shared_buffers的1/32）
max_wal_size = 10GB                 # WAL最大尺寸（减少检查点频率）
min_wal_size = 2GB
wal_compression = on                # WAL压缩（节省磁盘）
wal_level = replica                 # 支持主从复制
archive_mode = on                   # 开启WAL归档（灾备）
archive_command = 'cp %p /pg_archive/%f'  # 归档命令（建议用rsync/对象存储）
autovacuum = on                     # 自动清理死元组
autovacuum_vacuum_scale_factor = 0.05  # 表数据变化5%触发清理（默认20%，调小更及时）
autovacuum_analyze_scale_factor = 0.02 # 分析触发阈值

# ================= 并发与查询性能 =================
max_parallel_workers_per_gather = 4  # 单查询并行工作线程（CPU核心数/2）
max_parallel_workers = 16            # 全局并行线程数（CPU核心数）
effective_io_concurrency = 200       # IO并发数（SSD设200，HDD设10）
random_page_cost = 1.1               # 随机页成本（SSD从4.0下调，贴近真实IO成本）
seq_page_cost = 1.0                  # 顺序页成本
default_statistics_target = 1000     # 统计信息采样（提升执行计划准确性）

# ================= 超时与稳定性 =================
tcp_keepalives_idle = 60             # TCP保活（避免无效连接）
tcp_keepalives_interval = 10
tcp_keepalives_count = 5
idle_in_transaction_session_timeout = 30000  # 事务空闲超时（5分钟，释放连接）
statement_timeout = 300000           # 单语句超时（5分钟，防止慢查询阻塞）
lock_timeout = 60000                 # 锁等待超时（1分钟）

# ================= 日志与可观测性 =================
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d.log'
log_min_duration_statement = 1000    # 记录执行>1秒的慢查询
log_lock_waits = on                  # 记录锁等待（排查阻塞）
log_checkpoints = on                 # 记录检查点（分析IO峰值）
log_connections = on                 # 连接日志（审计）
log_disconnections = on
log_statement = 'none'               # 生产环境关闭全语句日志（避免性能损耗）
